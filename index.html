<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trlava</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            background: #111;
            font-family: 'Arial', sans-serif;
            position: fixed;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-wrapper {
            width: 100%;
            height: 100%;
            max-width: 1200px;
            max-height: 800px;
            position: relative;
            overflow: hidden;
            border: 4px solid #333;
            box-shadow: 0 0 20px rgba(255, 100, 100, 0.5);
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: #222;
        }
        
        .background {
            table-layout: fixed;
            border-spacing: 0;
        }
        
        .background td {
            padding: 0;
            margin: 0;
        }
        
        .lava, .actor {
            background: #e55;
        }
        
        .wall {
            background: #444;
            border: solid 3px #333;
            box-sizing: border-box;
        }
        
        .actor {
            position: absolute;
        }
        
        .coin {
            background: #e2e838;
            border-radius: 50%;
            box-shadow: 0 0 8px yellow;
        }
        
        .player {
            background: transparent;
            box-shadow: none;
            border-radius: 3px;
            background-size: cover;
            background-position: center;
            transition: transform 0.1s;
        }
        
        .lost .player {
            background: #a04040;
            background-image: none !important;
        }
        
        .won .player {
            background: green;
            background-image: none !important;
        }
        
        .game {
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        
        #instructions {
            position: fixed;
            bottom: 15px;
            left: 15px;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 5px;
            z-index: 100;
            transition: opacity 1s;
        }
        
        #level-info {
            position: fixed;
            top: 15px;
            right: 15px;
            color: #fff;
            font-family: monospace;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 5px;
            z-index: 100;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 10px;
        }
        
        /* Controles táctiles */
        #touch-controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 100;
            box-sizing: border-box;
        }
        
        .touch-section {
            display: flex;
            gap: 25px;
        }
        
        .touch-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .touch-btn:active {
            background: rgba(255, 255, 255, 0.5);
        }
        
        #jump-btn {
            background: rgba(255, 100, 100, 0.5);
        }
        
        #jump-btn:active {
            background: rgba(255, 100, 100, 0.7);
        }
        
        /* Indicador de que es un juego táctil */
        .touch-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        
        /* Modo pantalla completa */
        #fullscreen-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            padding: 6px 12px;
            cursor: pointer;
            z-index: 100;
            font-family: monospace;
            font-size: 14px;
        }
        
        #fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="level-info">Nivel 1</div>
            <div id="instructions">Controles: A (izq) - D (der) - W/ESPACIO (saltar)</div>
            <div id="loading">Cargando juego...</div>
            <button id="fullscreen-btn">Pantalla Completa</button>
            
            <!-- Controles táctiles -->
            <div id="touch-controls">
                <div class="touch-section">
                    <div class="touch-btn" id="left-btn">←</div>
                    <div class="touch-btn" id="right-btn">→</div>
                </div>
                <div class="touch-section">
                    <div class="touch-btn" id="jump-btn">↑</div>
                </div>
            </div>
            
            <div class="touch-indicator" id="touch-indicator">Toque para comenzar</div>
        </div>
    </div>

    <script>
        // Detectar si es un dispositivo táctil
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
        
        if (isTouchDevice) {
            document.getElementById('instructions').textContent = "Controles: A (izq) - D (der) - W/ESPACIO (saltar) | Toque los botones para moverse";
            document.getElementById('touch-controls').style.display = 'flex';
            document.getElementById('touch-indicator').style.display = 'block';
        }

        // Precargar las imágenes del jugador
        var playerImages = {
            idle: new Image(),
            walk1: new Image(),
            walk2: new Image(),
            jump: new Image()
        };
        
        var imagesLoaded = 0;
        var totalImages = Object.keys(playerImages).length;
        var imageLoaded = false;
        
        // Función para verificar si todas las imágenes se cargaron
        function checkAllImagesLoaded() {
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
                imageLoaded = true;
                document.getElementById('loading').style.display = 'none';
                initGame();
            }
        }
        
        // Configurar eventos de carga para todas las imágenes
        for (var key in playerImages) {
            playerImages[key].onload = checkAllImagesLoaded;
            playerImages[key].onerror = function() {
                console.error("Error cargando imagen: " + this.src);
                checkAllImagesLoaded();
            };
        }
        
        // Cargar las imágenes
        playerImages.idle.src = 'assets/player.png';
        playerImages.walk1.src = 'assets/player.png';
        playerImages.walk2.src = 'assets/player2.png';
        playerImages.jump.src = 'assets/player3.png';
        
        // Niveles del juego
        var LEVELS = [
            [
                '                                                                                ',
                '                                                                                ',
                '                                                                                ',
                '                                                                                ',
                '                                                                                ',
                '                                                                                ',
                '                                                                  xxx           ',
                '                                                   xx      xx    xx!xx          ',
                '                                    o o      xx                  x!!!x          ',
                '                                                                 xx!xx          ',
                '                                   xxxxx                          xvx           ',
                '                                                                            xx  ',
                '  xx                                      o o                                x  ',
                '  x                     o                                                    x  ',
                '  x                                      xxxxx                             o x  ',
                '  x          xxxx       o                                                    x  ',
                '  x  @       x  x                                                xxxxx       x  ',
                '  xxxxxxxxxxxx  xxxxxxxxxxxxxxx   xxxxxxxxxxxxxxxxxxxx     xxxxxxx   xxxxxxxxx  ',
                '                              x   x                  x     x                    ',
                '                              x!!!x                  x!!!!!x                    ',
                '                              x!!!x                  x!!!!!x                    ',
                '                              xxxxx                  xxxxxxx                    ',
                '                                                                                ',
                '                                                                                ',
            ],
            [
                '                                      x!!x                        xxxxxxx                                    x!x  ',
                '                                      x!!x                     xxxx     xxxx                                 x!x  ',
                '                                      x!!xxxxxxxxxx           xx           xx                                x!x  ',
                '                                      xx!!!!!!!!!!xx         xx             xx                               x!x  ',
                '                                       xxxxxxxxxx!!x         x                                    o   o   o  x!x  ',
                '                                                xx!x         x     o   o                                    xx!x  ',
                '                                                 x!x         x                                xxxxxxxxxxxxxxx!!x  ',
                '                                                 xvx         x     x   x                        !!!!!!!!!!!!!!xx  ',
                '                                                             xx  |   |   |  xx            xxxxxxxxxxxxxxxxxxxxx   ',
                '                                                              xx!!!!!!!!!!!xx            v                        ',
                '                                                               xxxx!!!!!xxxx                                      ',
                '                                               x     x            xxxxxxx        xxx         xxx                  ',
                '                                               x     x                           x x         x x                  ',
                '                                               x     x                             x         x                    ',
                '                                               x     x                             xx        x                    ',
                '                                               xx    x                             x         x                    ',
                '                                               x     x      o  o     x   x         x         x                    ',
                '               xxxxxxx        xxx   xxx        x     x               x   x         x         x                    ',
                '              xx     xx         x   x          x     x     xxxxxx    x   x   xxxxxxxxx       x                    ',
                '             xx       xx        x o x          x    xx               x   x   x               x                    ',
                '     @       x         x        x   x          x     x               x   x   x               x                    ',
                '    xxx      x         x        x   x          x     x               x   xxxxx   xxxxxx      x                    ',
                '    x x      x         x       xx o xx         x     x               x     o     x x         x                    ',
                '!!!!x x!!!!!!x         x!!!!!!xx     xx!!!!!!!!xx    x!!!!!!!!!!     x     =     x x         x                    ',
                '!!!!x x!!!!!!x         x!!!!!xx       xxxxxxxxxx     x!!!!!!!xx!     xxxxxxxxxxxxx xx  o o  xx                    ',
                '!!!!x x!!!!!!x         x!!!!!x    o                 xx!!!!!!xx !                    xx     xx                     ',
                '!!!!x x!!!!!!x         x!!!!!x                     xx!!!!!!xx  !                     xxxxxxx                      ',
                '!!!!x x!!!!!!x         x!!!!!xx       xxxxxxxxxxxxxx!!!!!!xx   !                                                  ',
                '!!!!x x!!!!!!x         x!!!!!!xxxxxxxxx!!!!!!!!!!!!!!!!!!xx    !                                                  ',
                '!!!!x x!!!!!!x         x!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!xx     !                                                  ',
            ],
            [
                '                                                                                                              ',
                '                                                                                                              ',
                '                                                                                                              ',
                '                                                                                                              ',
                '                                                                                                              ',
                '                                        o                                                                     ',
                '                                                                                                              ',
                '                                        x                                                                     ',
                '                                        x                                                                     ',
                '                                        x                                                                     ',
                '                                        x                                                                     ',
                '                                       xxx                                                                    ',
                '                                       x x                 !!!        !!!  xxx                                ',
                '                                       x x                 !x!        !x!                                     ',
                '                                     xxx xxx                x          x                                      ',
                '                                      x   x                 x   oooo   x       xxx                            ',
                '                                      x   x                 x          x      x!!!x                           ',
                '                                      x   x                 xxxxxxxxxxxx       xxx                            ',
                '                                     xx   xx      x   x      x                                                ',
                '                                      x   xxxxxxxxx   xxxxxxxx              x x                               ',
                '                                      x   x           x                    x!!!x                              ',
                '                                      x   x           x                     xxx                               ',
                '                                     xx   xx          x                                                       ',
                '                                      x   x= = = =    x            xxx                                        ',
                '                                      x   x           x           x!!!x                                       ',
                '                                      x   x    = = = =x     o      xxx       xxx                              ',
                '                                     xx   xx          x                     x!!!x                             ',
                '                              o   o   x   x           x     x                xxv        xxx                   ',
                '                                      x   x           x              x                 x!!!x                  ',
                '                             xxx xxx xxx xxx     o o  x!!!!!!!!!!!!!!x                   vx                   ',
                '                             x xxx x x xxx x          x!!!!!!!!!!!!!!x                                        ',
                '                             x             x   xxxxxxxxxxxxxxxxxxxxxxx                                        ',
                '                             xx           xx                                         xxx                      ',
                '  xxx                         x     x     x                                         x!!!x                xxx  ',
                '  x x                         x    xxx    x                                          xxx                 x x  ',
                '  x                           x    xxx    xxxxxxx                        xxxxx                             x  ',
                '  x                           x           x                              x   x                             x  ',
                '  x                           xx          x                              x x x                             x  ',
                '  x                                       x       |xxxx|    |xxxx|     xxx xxx                             x  ',
                '  x                xxx             o o    x                              x         xxx                     x  ',
                '  x               xxxxx       xx          x                             xxx       x!!!x          x         x  ',
                '  x               oxxxo       x    xxx    x                             x x        xxx          xxx        x  ',
                '  x                xxx        xxxxxxxxxxxxx  x oo x    x oo x    x oo  xx xx                    xxx        x  ',
                '  x      @          x         x           x!!x    x!!!!x    x!!!!x    xx   xx                    x         x  ',
                '  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx           xxxxxxxxxxxxxxxxxxxxxxxxxxxxx     xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  ',
                '                                                                                                              ',
                '                                                                                                              ',
            ],
            [
                '                                                                                                  xxx x       ',
                '                                                                                                      x       ',
                '                                                                                                  xxxxx       ',
                '                                                                                                  x           ',
                '                                                                                                  x xxx       ',
                '                          o                                                                       x x x       ',
                '                                                                                             o o oxxx x       ',
                '                   xxx                                                                                x       ',
                '       !  o  !                                                xxxxx xxxxx xxxxx xxxxx xxxxx xxxxx xxxxx       ',
                '       x     x                                                x   x x   x x   x x   x x   x x   x x           ',
                '       x= o  x            x                                   xxx x xxx x xxx x xxx x xxx x xxx x xxxxx       ',
                '       x     x                                                  x x   x x   x x   x x   x x   x x     x       ',
                '       !  o  !            o                                  xxxx xxxxx xxxxx xxxxx xxxxx xxxxx xxxxxxx       ',
                '                                                                                                              ',
                '          o              xxx                              xx                                                  ',
                '                                                                                                              ',
                '                                                                                                              ',
                '                                                      xx                                                      ',
                '                   xxx         xxx                                                                            ',
                '                                                                                                              ',
                '                          o                                                     x      x                      ',
                '                                                          xx     xx                                           ',
                '             xxx         xxx         xxx                                 x                  x                 ',
                '                                                                                                              ',
                '                                                                 ||                                           ',
                '  xxxxxxxxxxx                                                                                                 ',
                '  x         x o xxxxxxxxx o xxxxxxxxx o xx                                                x                   ',
                '  x         x   x       x   x       x   x                 ||                  x     x                         ',
                '  x  @      xxxxx   o   xxxxx   o   xxxxx                                                                     ',
                '  xxxxxxx                                     xxxxx       xx     xx     xxx                                   ',
                '        x=                  =                =x   x                     xxx                                   ',
                '        xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx   x!!!!!!!!!!!!!!!!!!!!!xxx!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
                '                                                  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
                '                                                                                                              ',
            ],
        ];

        function initGame() {
            // Ocultar indicador táctil al comenzar
            document.getElementById('touch-indicator').style.display = 'none';
            
            // Configurar botón de pantalla completa
            document.getElementById('fullscreen-btn').addEventListener('click', function() {
                const elem = document.getElementById('game-wrapper');
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            });
            
            // Clase Vector para manejar posiciones y movimientos
            function Vector(x, y) {
                this.x = x;
                this.y = y;
            }

            Vector.prototype.plus = function (other) {
                return new Vector(this.x + other.x, this.y + other.y);
            };

            Vector.prototype.times = function (scale) {
                return new Vector(this.x * scale, this.y * scale);
            };

            // Definición de tipos de actores
            var actorchars = {
                '@': Player,
                'o': Coin,
                '=': Lava,
                '|': Lava,
                'v': Lava,
            };

            // Definición de la clase Player
            function Player(pos) {
                this.pos = pos.plus(new Vector(0, -0.5));
                this.size = new Vector(0.8, 1.8); // Tamaño fijo del jugador
                this.pos = pos.plus(new Vector(0, -(this.size.y - 1))); // Ajuste dinámico para no atravesar el suelo
                this.speed = new Vector(0, 0);
                this.facing = 'right'; // Dirección a la que mira el jugador
                this.walkFrame = 0; // Frame actual de la animación de caminar
                this.walkTimer = 0; // Temporizador para la animación de caminar
                this.isJumping = false; // Si está saltando
            }

            Player.prototype.type = 'player';

            // Definición de la clase Lava
            function Lava(pos, ch) {
                this.pos = pos;
                this.size = new Vector(1, 1);
                if (ch === '=') this.speed = new Vector(2, 0);
                else if (ch === '|') this.speed = new Vector(0, 2);
                else if (ch === 'v') {
                    this.speed = new Vector(0, 3);
                    this.repeatPos = pos;
                }
            }
            Lava.prototype.type = 'lava';

            // Definición de la clase Coin
            function Coin(pos) {
                this.basePos = this.pos = pos.plus(new Vector(0.2, 0.1));
                this.size = new Vector(0.6, 0.6);
                this.wobble = Math.random() * Math.PI * 2;
            }
            Coin.prototype.type = 'coin';

            // Definición de la clase Level
            function Level(plan) {
                this.width = plan[0].length;
                this.height = plan.length;
                this.grid = [];
                this.actors = [];

                for (var y = 0; y < this.height; y++) {
                    var line = plan[y],
                        gridLine = [];
                    for (var x = 0; x < this.width; x++) {
                        var ch = line[x],
                            fieldType = null;
                        var Actor = actorchars[ch];
                        if (Actor) this.actors.push(new Actor(new Vector(x, y), ch));
                        else if (ch === 'x') fieldType = 'wall';
                        else if (ch === '!') fieldType = 'lava';
                        gridLine.push(fieldType);
                    }
                    this.grid.push(gridLine);
                }
                
                this.player = this.actors.filter(function (actor) {
                    return actor.type === 'player';
                })[0];
                
                this.status = this.finishDelay = null;
            }

            // Verificar si el nivel está terminado
            Level.prototype.isFinished = function () {
                return this.status != null && this.finishDelay < 0;
            };

            // Verificar obstáculos en una posición
            Level.prototype.obstacleAt = function (pos, size) {
                var xStart = Math.floor(pos.x);
                var xEnd = Math.ceil(pos.x + size.x);
                var yStart = Math.floor(pos.y);
                var yEnd = Math.ceil(pos.y + size.y);

                if (xStart < 0 || xEnd > this.width || yStart < 0) return 'wall';
                if (yEnd > this.height) return 'lava';
                
                for (var y = yStart; y < yEnd; y++) {
                    for (var x = xStart; x < xEnd; x++) {
                        var fieldType = this.grid[y][x];
                        if (fieldType) return fieldType;
                    }
                }
            };

            // Verificar colisión con otros actores
            Level.prototype.actorAt = function (actor) {
                for (var i = 0; i < this.actors.length; i++) {
                    var other = this.actors[i];
                    if (other != actor &&
                        actor.pos.x + actor.size.x > other.pos.x &&
                        actor.pos.x < other.pos.x + other.size.x &&
                        actor.pos.y + actor.size.y > other.pos.y &&
                        actor.pos.y < other.pos.y + other.size.y)
                        return other;
                }
            };

            // Animar el nivel
            Level.prototype.animate = function (step, keys) {
                if (this.status != null) this.finishDelay -= step;

                while (step > 0) {
                    var thisStep = Math.min(step, 0.05);
                    this.actors.forEach(function (actor) {
                        actor.act(thisStep, this, keys);
                    }, this);
                    step -= thisStep;
                }
            };

            // Manejar toques del jugador
            Level.prototype.playerTouched = function (type, actor) {
                if (type == 'lava' && this.status == null) {
                    this.status = 'lost';
                    this.finishDelay = 1;
                } else if (type == 'coin') {
                    this.actors = this.actors.filter(function (other) {
                        return other != actor;
                    });
                    if (!this.actors.some(function (actor) {
                        return actor.type == 'coin';
                    })) {
                        this.status = 'won';
                        this.finishDelay = 1;
                    }
                }
            };

            // Comportamiento de Lava
            Lava.prototype.act = function (step, level) {
                var newPos = this.pos.plus(this.speed.times(step));
                if (!level.obstacleAt(newPos, this.size)) this.pos = newPos;
                else if (this.repeatPos) this.pos = this.repeatPos;
                else this.speed = this.speed.times(-1);
            };

            // Comportamiento de Coin
            var wobbleSpeed = 8,
                wobbleDist = 0.07;
            
            Coin.prototype.act = function (step) {
                this.wobble += step * wobbleSpeed;
                var wobblePos = Math.sin(this.wobble) * wobbleDist;
                this.pos = this.basePos.plus(new Vector(0, wobblePos));
            };

            // Movimiento horizontal del jugador
            var playerXSpeed = 7;
            
            Player.prototype.moveX = function (step, level, keys) {
                this.speed.x = 0;
                var wasMoving = keys.left || keys.right;
                
                if (keys.left) {
                    this.speed.x -= playerXSpeed;
                    this.facing = 'left';
                }
                if (keys.right) {
                    this.speed.x += playerXSpeed;
                    this.facing = 'right';
                }

                var motion = new Vector(this.speed.x * step, 0);
                var newPos = this.pos.plus(motion);
                var obstacle = level.obstacleAt(newPos, this.size);
                if (obstacle) level.playerTouched(obstacle);
                else this.pos = newPos;
                
                // Animación de caminar
                if (wasMoving) {
                    this.walkTimer += step;
                    if (this.walkTimer > 0.15) { // Cambiar frame cada 0.15 segundos
                        this.walkTimer = 0;
                        this.walkFrame = this.walkFrame === 0 ? 1 : 0;
                    }
                } else {
                    this.walkTimer = 0;
                    this.walkFrame = 0;
                }
            };

            // Movimiento vertical y gravedad
            var gravity = 30;
            var jumpSpeed = 17;
            
            Player.prototype.moveY = function (step, level, keys) {
            this.speed.y += step * gravity;
            var motion = new Vector(0, this.speed.y * step);
            var newPos = this.pos.plus(motion);
            var obstacle = level.obstacleAt(newPos, this.size);

            if (obstacle) {
                level.playerTouched(obstacle);

                // Si está en el suelo y presiona salto
                if ((keys.up || keys.space) && this.speed.y >= 0) {
                    this.speed.y = -jumpSpeed;
                    this.isJumping = true;   // Activar salto
                } else {
                    this.speed.y = 0;
                    this.isJumping = false;  // En el suelo
                }
            } else {
                this.pos = newPos;
            }
        };

            // Acciones del jugador
            Player.prototype.act = function (step, level, keys) {
                this.moveX(step, level, keys);
                this.moveY(step, level, keys);

                var otherActor = level.actorAt(this);
                if (otherActor) level.playerTouched(otherActor.type, otherActor);

                // Animación de perder
                // Animación de perder (sin modificar el tamaño del sprite)
               if (level.status == 'lost') {
               this.pos.y += step;
              this._isDying = true; // flag de animación de muerte
                }
            };

            // Obtener la imagen actual del jugador según su estado
            Player.prototype.getCurrentImage = function() {
                if (this.isJumping) {
                    return playerImages.jump;
                } else if (this.speed.x !== 0) {
                    return this.walkFrame === 0 ? playerImages.walk1 : playerImages.walk2;
                } else {
                    return playerImages.idle;
                }
            };

            // Helper para crear elementos DOM
            function element(name, className) {
                var elem = document.createElement(name);
                if (className) elem.className = className;
                return elem;
            }

            // Display del juego en DOM
            function DOMDisplay(parent, level) {
                this.wrap = parent.appendChild(element('div', 'game'));
                this.level = level;
                
                // Hacer el contenedor del juego del tamaño del nivel
                this.wrap.style.width = (level.width * scale) + 'px';
                this.wrap.style.height = (level.height * scale) + 'px';
                this.wrap.style.position = 'absolute';
                this.wrap.style.top = '0';
                this.wrap.style.left = '0';
                
                this.wrap.appendChild(this.drawBackground());
                this.actorLayer = null;
                this.drawFrame();
            }

            // Escala aumentada para hacer todo más grande
            var scale = 25;

            // Dibujar el fondo
            DOMDisplay.prototype.drawBackground = function () {
                var table = element('table', 'background');
                table.style.width = this.level.width * scale + 'px';
                table.style.height = this.level.height * scale + 'px';
                
                for (var y = 0; y < this.level.height; y++) {
                    var rowElement = table.appendChild(element('tr'));
                    rowElement.style.height = scale + 'px';
                    
                    for (var x = 0; x < this.level.width; x++) {
                        var cell = element('td');
                        var fieldType = this.level.grid[y][x];
                        if (fieldType) cell.className = fieldType;
                        cell.style.width = scale + 'px';
                        cell.style.height = scale + 'px';
                        rowElement.appendChild(cell);
                    }
                }
                return table;
            };

            // Dibujar los actores
            DOMDisplay.prototype.drawActors = function () {
                var wrap = element('div');
                wrap.style.position = 'absolute';
                wrap.style.top = '0';
                wrap.style.left = '0';
                wrap.style.width = (this.level.width * scale) + 'px';
                wrap.style.height = (this.level.height * scale) + 'px';
                
                for (var i = 0; i < this.level.actors.length; i++) {
                    var actor = this.level.actors[i];
                    var rect = element('div', 'actor ' + actor.type);
                    rect.style.width = actor.size.x * scale + 'px';
                    rect.style.height = actor.size.y * scale + 'px';
                    rect.style.left = actor.pos.x * scale + 'px';
                    rect.style.top = actor.pos.y * scale + 'px';
                    rect.style.position = 'absolute';
                    
                    // Si es el jugador, aplicar la imagen y efectos correspondientes
                    if (actor.type === 'player') {
                        if (imageLoaded) {
                            rect.style.backgroundImage = "url('" + actor.getCurrentImage().src + "')";
                            rect.style.backgroundSize = "cover";
                            rect.style.backgroundRepeat = "no-repeat";
                            rect.style.backgroundPosition = "center";
                            rect.style.backgroundColor = "transparent";
                            

                            // Aplicar efecto espejo si mira a la izquierda
                            if (actor.facing === 'left') {
                                rect.style.transform = "scaleX(-1)";
                            } else {
                                rect.style.transform = "scaleX(1)";
                            }
                        }
                    }
                    
                    wrap.appendChild(rect);
                }
                return wrap;
            };

            // Dibujar un frame
            DOMDisplay.prototype.drawFrame = function () {
                if (this.actorLayer) this.wrap.removeChild(this.actorLayer);
                this.actorLayer = this.wrap.appendChild(this.drawActors());
                this.wrap.className = 'game ' + (this.level.status || '');
                this.scrollPlayerIntoView();
            };

            // Ajustar scroll para mantener al jugador visible (horizontal y vertical)
            DOMDisplay.prototype.scrollPlayerIntoView = function () {
                var container = this.wrap.parentNode;
                var player = this.level.player;
                var center = player.pos.plus(player.size.times(0.5)).times(scale);
                
                // Calcular la posición para el scroll
                var targetScrollLeft = center.x - (container.clientWidth / 2);
                var targetScrollTop = center.y - (container.clientHeight / 2);
                
                // Limitar el scroll para no salirse de los bordes
                targetScrollLeft = Math.max(0, Math.min(targetScrollLeft, this.level.width * scale - container.clientWidth));
                targetScrollTop = Math.max(0, Math.min(targetScrollTop, this.level.height * scale - container.clientHeight));
                
                // Aplicar el scroll
                container.scrollLeft = targetScrollLeft;
                container.scrollTop = targetScrollTop;
            };

            // Limpiar el display
            DOMDisplay.prototype.clear = function () {
                this.wrap.parentNode.removeChild(this.wrap);
            };

            // Seguimiento de teclas (W, A, D, espacio)
            var keyCodes = { 
                65: 'left',   // A
                68: 'right',  // D
                87: 'up',     // W
                32: 'space'   // Espacio
            };
            
            // Estado de los controles
            var pressedKeys = {
                left: false,
                right: false,
                up: false,
                space: false
            };
            
            // Estado de los controles táctiles
            var touchControlsState = {
                left: false,
                right: false,
                space: false
            };
            
            function trackKeys() {
                function handler(event) {
                    if (keyCodes.hasOwnProperty(event.keyCode)) {
                        var down = event.type == 'keydown';
                        pressedKeys[keyCodes[event.keyCode]] = down;
                        event.preventDefault();
                    }
                }
                
                // Registrar eventos de teclado
                addEventListener('keydown', handler);
                addEventListener('keyup', handler);
                
                return pressedKeys;
            }

            // Configurar eventos táctiles
            if (isTouchDevice) {
                document.getElementById('left-btn').addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    touchControlsState.left = true;
                });
                
                document.getElementById('left-btn').addEventListener('touchend', function(e) {
                    e.preventDefault();
                    touchControlsState.left = false;
                });
                
                document.getElementById('right-btn').addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    touchControlsState.right = true;
                });
                
                document.getElementById('right-btn').addEventListener('touchend', function(e) {
                    e.preventDefault();
                    touchControlsState.right = false;
                });
                
                document.getElementById('jump-btn').addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    touchControlsState.space = true;
                });
                
                document.getElementById('jump-btn').addEventListener('touchend', function(e) {
                    e.preventDefault();
                    touchControlsState.space = false;
                });
                
                // Prevenir desplazamiento en dispositivos táctiles
                document.addEventListener('touchmove', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }

            // Ejecutar animación
            function runAnimation(frameFunc) {
                var lastTime = null;
                
                function frame(time) {
                    var stop = false;
                    if (lastTime != null) {
                        var timeStep = Math.min(time - lastTime, 100) / 1000;
                        stop = frameFunc(timeStep) === false;
                    }
                    lastTime = time;
                    if (!stop) requestAnimationFrame(frame);
                }
                requestAnimationFrame(frame);
            }

            // Ejecutar un nivel
            function runLevel(level, Display, andThen) {
                var display = new Display(document.getElementById('game-container'), level);
                var arrows = trackKeys();
                
                runAnimation(function (step) {
                    // Combinar controles de teclado y táctiles
                    var combinedKeys = {
                        left: pressedKeys.left || touchControlsState.left,
                        right: pressedKeys.right || touchControlsState.right,
                        up: pressedKeys.up || touchControlsState.space,
                        space: pressedKeys.space || touchControlsState.space
                    };
                    
                    level.animate(step, combinedKeys);
                    display.drawFrame(step);
                    
                    if (level.isFinished()) {
                        display.clear();
                        if (andThen) andThen(level.status);
                        return false;
                    }
                });
            }

            // Ejecutar el juego completo
            var currentLevel = 0;
            
            function runGame(plans, Display) {
                function startLevel(n) {
                    currentLevel = n;
                    document.getElementById('level-info').textContent = 'Nivel ' + (n + 1);
                    
                    runLevel(new Level(plans[n]), Display, function (status) {
                        if (status == 'lost') {
                            setTimeout(function() {
                                startLevel(n);
                            }, 1000);
                        } else if (n < plans.length - 1) {
                            setTimeout(function() {
                                startLevel(n + 1);
                            }, 1000);
                        } else {
                            document.getElementById('level-info').textContent = '¡Has ganado!';
                        }
                    });
                }
                startLevel(0);
            }

            // Iniciar el juego
            runGame(LEVELS, DOMDisplay);
            
            // Ocultar instrucciones después de 5 segundos
            setTimeout(function() {
                document.getElementById('instructions').style.opacity = '0.3';
            }, 5000);
        }


    </script> 

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log("SW registrado:", reg))
          .catch(err => console.error("Error SW:", err));
      });
    }
  </script>
    
</body>
</html>
